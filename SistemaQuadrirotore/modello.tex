\chapter{Sistema Quadrirotore}
Il capitolo è incentrato sulla descrizione del modello matematico del sistema quadricottero con le relative dinamiche, leggi di guida e leggi di controllo possibili da implementare.
\section{Modello matematico}
Il principio di funzionamento del quadrirotore è relativamente semplice nel suo complesso. Come accennato in precedenza la gestione dell'assetto è ottenuta attraverso l'azionamento differenziale dei rotori, montati su di una struttura rigida \cite{modelquad}.
Nel seguente elenco di manovre di base , viene preso come riferimento la figura \ref{fig:modello_quad}.
\begin{figure}
	\centering
	\begin{subfigure}{0.45\textwidth}
		\centering
		\includegraphics[width=1\textwidth]{SistemaQuadrirotore/Figure/drone_alto}
		\caption{Numerazione rotori}
		\label{fig:modello_quad}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.45\textwidth}
		\centering
		\includegraphics[width=1\textwidth]{SistemaQuadrirotore/Figure/drone_pitch}
		\caption{Variare l'angolo di beccheggio}
		\label{fig:modello_quad_pitch}
	\end{subfigure}
	\\
	\begin{subfigure}{0.45\textwidth}
		\centering
		\includegraphics[width=1\textwidth]{SistemaQuadrirotore/Figure/drone_roll}
		\caption{Variare l'angolo di rollio}
		\label{fig:modello_quad_roll}
	\end{subfigure}
	\hfill
	\begin{subfigure}{0.45\textwidth}
		\centering
		\includegraphics[width=1\textwidth]{SistemaQuadrirotore/Figure/drone_yaw}
		\caption{Variare l'angolo di imbardata}
		\label{fig:modello_quad_yaw}
	\end{subfigure}
	\caption{Schemi semplificati dell'azionamento del quadrirotore}
\end{figure}
\begin{itemize}
	\item \textbf{Comando di beccheggio : } una variazione di beccheggio positiva lungo l'asse y del corpo del drone avviene applicando maggiore forza ai rotori 2 e 3 rispetto ai 1 e 4, come mostrato nella figura \ref{fig:modello_quad_pitch}
	\item \textbf{Comando di rollio : } una variazione di vriazione dell'angolo di rollio positiva si ottiene modificando la velocità di azionamento dei rotori in modo simmetrico rispetto all'asse y del drone. come mostra la figura \ref{fig:modello_quad_roll} una variazione positiva si ottiene facendo ruotare i rotori 1 e 3 più lentamente dei rotori 2 e 4.
	\item \textbf{Comando di imbardata : } Questo comando è il meno efficace nel quadricottero in quando viene implementato attraverso un effetto secondario. Come si vede nella figura \ref{fig:modello_quad_yaw}, la rotazione dei rotori viene, mantendendo la portanza totale costante, distribuita in modo differente tra le pale che ruotano in modo orario e antiorario. Il comando di variazione positivo dell'angolo di imbardata si ottiene facendo ruotare più rapidamente i rotori 1 e 2 rispetto a 3 e 4.
	\item \textbf{Comando di spinta complessiva : } La variazione di quota avviene grazie a questo tipo di comando. Aumentando o diminuendo in modo identico la velocità di rotazione dei rotori è possibile equilibrare il peso, contrastato dalla portanza da essi generata. una portanza maggiore si traduce in una accelerazione verso l'alto, viceversa una diminuzione.
\end{itemize}
Grazie a questo funzionamento e l'utilizzo di un mixer, che ha lo scopo di mescolare i quattro tipi di azionamento visti, si può governare il velivolo modificandone la posizione nello spazio \cite{DesTestCarm}.
\subsubsection{Relazioni matematiche}
Verranno esplicitate alcune formule utili per la modellazione iniziale del problema del quadrirotore come riportato in bibliografia, \cite{DesTestCarm}, \cite{baseTesi}.

Utilizzando i sistemi di riferimento del corpo del drone e del riferimento terreste come in figura \ref{fig:riferimenti}, si definisce la matrice di rotazione $R$ espressa dalla relazione \ref{eq:SistemaQuadrirotore_R}. In questo sistema si impongono che l'asse $x$ del corpo sia diretto ferso il muso del drone e l'asse $y$ verso destra, in modo che l'asse $z$ sia diretto verso il basso, mentre l'asse $x_e$ risulta essere diretto verso nord, l'asse $y_e$ verso est e di conseguenza l'asse $z_e$ verso il centro della terra. 
Attraverso il sistema di equazioni , espresso in forma matriciale \ref{eq:SistemaQuadrirotore_ratei}, si ricavano i retei degli angoli di assetto partendo dalle accelerazioni angolari, utillizzando per  comodità le seguenti semplificazioni di scrittura : 
\[ 	c(\cdot)=\cos(\cdot)\ ,\  s(\cdot) = \sin(\cdot) \]
\begin{equation}
R=
	\begin{pmatrix}
	c(\psi)c(\theta)-s(\phi)s(\psi)s(\theta) & -c(\phi)s(\psi) & c(\psi)s(\theta)+c(\theta)s(\theta)s(\psi) \\ 
	c(\theta) s(\psi)+c(\psi)s(\phi)s(\theta) & c(\phi)c(\psi) & s(\psi)s(\theta)-c(\psi)c(\theta)s(\phi) \\ 
	-c(\phi)s(\theta)	& s(\phi) & c(\phi)c(\theta)
	\end{pmatrix}
	\label{eq:SistemaQuadrirotore_R}
\end{equation}
\begin{equation}
	\begin{Bmatrix}
		\dot{\phi}\\
		\dot{\theta}\\
		\dot{\psi}
		\end{Bmatrix}=
	\begin{pmatrix}
		1 & \sin(\phi)\tan(\theta) & \cos(\phi)\tan(\theta) \\ 
		0 & \cos(\phi) & -\sin(\phi) \\ 
		0 & \frac{\sin(\phi)}{\cos(\theta)} & \frac{\cos(\phi)}{\cos(\theta)}
	\end{pmatrix}
	\begin{Bmatrix}
		p\\
		q\\
		r
	\end{Bmatrix}
	\label{eq:SistemaQuadrirotore_ratei}
\end{equation}

\begin{figure}
	\centering
	\includegraphics[width=0.33\textwidth]{SistemaQuadrirotore/Figure/eulerangles.png}
	\caption{Rotazione tra sistemi di riferimento NED e corpo}
	\label{fig:riferimenti}
\end{figure}

Risulta utile presentare anche la rappresentazione di rotazioni nello spazio attraverso l'uso di quaternioni, molto utilizzata in applicazioni robotiche grazie alla possibilità di superare le limitazioni dovute alle singolarità presenti nella rappresentazione euleriana.
Si definisce quindi un quaternione :
\[ 
	\mathbb{q} = q_0 + q_1 \mathbf{i} + q_2 \mathbf{j} + q_3 \mathbf{k}
\]
Per comodità si utilizzeranno le scritture nelle forme :
\[ 
	\mathfrak{q} = \begin{Bmatrix}
		q_0\\
		\mathbf{q}
	\end{Bmatrix} \ , \ \mathbf{q} = \begin{Bmatrix}
		q_1\\
		q_2\\
		q_3
	\end{Bmatrix}
\]
Nella definizione del quaternione $\mathbf{i}$,$\mathbf{j}$ e $\mathbf{k}$ sono l'equivalente di numeri complessi che godono tra di loro della proprietà di ortogonalità, mentre $q_0$, $q_1$, $q_2$ e $q_3$ sono numeri reali. Utilizzando la definizione del prodotto di Hamilton, \ref{eq:SistemaQuadrirotore_hamilton}, si può determinare il quaternione rappresentante l'errore da minimizzare nella fase di controllo, \ref{eq:SistemaQuadrirotore_errore}, dove $\mathfrak{q}_{est}$ è la misurazione e $ \mathfrak{q}_{ref}$ e il riferimento.
\begin{equation}\label{eq:SistemaQuadrirotore_hamilton}
	\mathfrak{q} \otimes \mathfrak{p} = q_0 p_0 - \mathbf{q} \cdot \mathbf{p} + q_0 \mathbf{p} + p_0 \mathbf{q} + \mathbf{q} \times \mathbf{p}
\end{equation}
\begin{equation}\label{eq:SistemaQuadrirotore_errore}
	\mathfrak{q}_{err} = \mathfrak{q}_{est}^{-1} \otimes \mathfrak{q}_{ref}
\end{equation}
La derivata del rotore nel tempo è esprimibile attraverso la relazione \ref{eq:SistemaQuadrirotore_quaternionederivato}, dove $p$, $q$ ed $r$ sono rispettivamente i ratei di rotazione rispetto agli assi $x$, $y$ e $z$.
\begin{equation}\label{eq:SistemaQuadrirotore_quaternionederivato}
\mathfrak{\dot{q}} = \frac{1}{2} \mathbf{\Omega} \mathfrak{q} =
	\begin{pmatrix}
		0 & -p & -q & -r \\
		p &  0 &  r & -q \\
		q &  r &  0 &  p \\
		r &  q & -p &  0 
	\end{pmatrix}
	\begin{Bmatrix}
		q_0 \\
		\mathbf{q}
	\end{Bmatrix}
\end{equation}
utilizzando le formule \ref{eq:SistemaQuadrirotore_Forze} e \ref{eq:SistemaQuadrirotore_momenti} si determinano relativamente le forze e i momenti applicati. Manipolando le relazioni precedenti si possono ottenere le accelerazioni e le accelerazioni angolari, \ref{eq:SistemaQuadrirotore_acc}, \ref{eq:SistemaQuadrirotore_accang}. Per esplicitare le accelerazioni angolari è necessario anche la formula \ref{eq:SistemaQuadrirotore_momento_qdm} che esprime il momento della quantità di moto.
\begin{equation}\label{eq:SistemaQuadrirotore_Forze}
	\mathbf{F} + \mathbf{R} m \mathbf{g} = m \left[\frac{d \mathbf{v}}{d t} + \boldsymbol{\omega}\times \mathbf{v}\right]
\end{equation}

\begin{equation}\label{eq:SistemaQuadrirotore_acc}
	\frac{\mathbf{F}}{m} + \mathbf{R} \mathbf{g} = \mathbf{\dot{v}} + \boldsymbol{\omega} \times \mathbf{v}
\end{equation}

\begin{equation}\label{eq:SistemaQuadrirotore_momenti}
	\boldsymbol{\tau} = \frac{d \mathbf{H}}{d t } + \boldsymbol{\omega} \times \mathbf{H}
\end{equation}

\begin{equation}\label{eq:SistemaQuadrirotore_momento_qdm}
	\mathbf{H} = \mathbf{J} \boldsymbol{\omega} =
	\begin{pmatrix}
		J_x & J_xy & J_xz \\
		-Jxy & J_y & -Jyz \\
		-Jxz & -Jyz & -Jz 
	\end{pmatrix}
	\begin{Bmatrix}
		p\\
		q\\
		r
	\end{Bmatrix}
\end{equation}

\begin{equation}\label{eq:SistemaQuadrirotore_accang}
	\boldsymbol{\dot{\omega}} = - \mathbf{J^{-1}}\left(\boldsymbol{\omega}\times\left(\mathbf{J}\boldsymbol{\omega}\right)\right) + \mathbf{J^{-1}}\boldsymbol{\tau}
\end{equation}

Si definiscono il vettore di stato e di comando come segue:
\[ 
	\mathbf{x} = \begin{Bmatrix}
		x \\ y \\ z \\ \phi \\ \theta \\ \psi \\ u \\ v \\ w \\ p \\ q \\ r
	\end{Bmatrix}, \  \mathbf{u} = \begin{Bmatrix}
	F_x \\ F_y \\ F_z \\ \tau_x \\ \tau_y \\ \tau_z
	\end{Bmatrix}
\]
Si definiscono inoltre le costanti : 
\[ 
	\begin{matrix}
	c_1 = \frac{J_{xz} (J_x -J_y + J_z)}{J_x J_y- J_xz^2} , & c_2 = \frac{J_xz (J_x -Jy +J_z)}{J_x J_y-J_xz^2}, &c_3 \frac{J_z}{J_x J_y - J_xz^2}, \\
	c_4 = \frac{J_xz}{J_x J_y -J_xz^2} ,& c_5 = \frac{J_z - J x}{J_y},& c_6 = \frac{J_xz}{J_y}, \\
	c_7 = \frac{1}{J_y} ,& c_8 = \frac{J_xz^2 + J_x (J_x - J_y)}{J_x J_y - J_xz^2},& c_9 =  \frac{J_x}{J_x J_y -J_xz^2}
	\end{matrix}
\]

Con le formule precedenti, si riformulano le equazioni differenziali ottenendo la scrittura stato spazio \ref{eq:SistemaQuadrirotore_statespace}, dove sono esplicitati gli elementi principali nelle relazioni \ref{eq:SistemaQuadrirotore_statespaceElement}.
\begin{equation}\label{eq:SistemaQuadrirotore_statespace}
\mathbf{\dot{x}} = \mathbf{f(x)} + \mathbf{g} \cdot \mathbf{u}
\end{equation}

\begin{equation}\label{eq:SistemaQuadrirotore_statespaceElement}
	\mathbf{f(x)} = \begin{Bmatrix}
		\mathbf{R} \begin{Bmatrix}
			u \\ v \\ w
		\end{Bmatrix} \\
		p + (q\sin(\phi)+r\cos(\phi))\tan(\theta) \\
		q\cos(\phi) - r\sin(\phi) \\
		\frac{q\sin(\phi) - r\cos(\phi)}{\cos(\theta)}\\
		rv-qw-g\sin(\theta)\\
		-ru + pw p g \sin(\phi)\cos(\theta)\\
		qu - pv + g \cos(\phi)\cos(\theta)\\
		q (c_1 r + c_2 p)\\
		c_5 pr - (p^2-r^2) c_6 \\
		q(c_8 p - c_2 r)
	\end{Bmatrix}, \ \mathbf{g} =
	\begin{pmatrix}
		0 & \cdots & \cdots & \cdots & \cdots & 0 \\
		0 & \ddots & & & & \vdots \\
		0 & & \ddots & & & \vdots \\
		0 & & & \ddots & & \vdots \\
		0 & & & & \ddots & \vdots \\
		0 & \cdots & \cdots & \cdots & \cdots & 0 \\
		\frac{1}{m} & 0 & \cdots & \cdots & \cdots & 0 \\
		0 & \frac{1}{m} & 0 & \cdots & \cdots & 0 \\
		0 & 0 & \frac{1}{m} & 0 & \cdots & 0 \\
		0 & \cdots & 0 & c_3 & 0 & c_4 \\
		0 & \ddots & \vdots & 0 & c_7 & 0 \\
		0 & \cdots & 0 & c_4 & 0 & c_9 \\
	\end{pmatrix}
\end{equation}

Quello presentato è quindi un modello matematico rappresentativo del comportamento del quadricottero, ottenibile integrando le equazioni differenziali che rappresenta.

\todo[inline]{Parlare del vettore di comando e del mixer}

La tesi precedente aveva trovato una relazione tra il segnale pwm e la spinta in modo sperimentale.
Viene usata una regressione quadratica.
Specificare il vettore u funzione del segnale pwm.
 
Rimando al capitolo di gazebo.

\todo[inline]{I sistemi di riferimento e la rotazione da uno al altro}
\todo[inline]{Definizione degli operatori necessari a descrivere il modello base del drone}
\todo[inline]{Forze e momenti applicati nel modello di partenza}
\todo[inline]{Breve descrizione alle modifiche fatte al modello per applicazione su gazebo con rimando al capitolo specifico}

\todo[inline]{Nel sottocapitolo seguente raccolta di possibili modelli di guide e di controllo}